// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "linux-musl-openssl-3.0.x", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      UserRole @default(ADMIN)
  avatar    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedTasks TaskAssignment[]
  createdTasks  Task[]           @relation("TaskCreator")
  updatedTasks  Task[]           @relation("TaskUpdater")

  // Contract relations
  createdContracts Contract[]
  
  // Global Controls relations
  notifications              Notification[]
  preference                 UserPreference?
  searchLogs                 SearchLog[]
  notificationPreferences    NotificationPreference[]

  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
  VIEWER
}

// Customer Management
model Customer {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  company     String?
  address     String?
  city        String?
  country     String   @default("UAE")
  industry    String?
  size        CompanySize?
  status      CustomerStatus @default(ACTIVE)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  servicePlans ServicePlan[]
  tasks        Task[]
  communications Communication[]

  // Contract relations
  contracts     Contract[]
  
  // Plan Builder relations
  plans         Plan[]
  
  // ERP Integration relations
  erpConnections ERPConnection[]

  @@map("customers")
}

enum CompanySize {
  STARTUP
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PROSPECT
}

// Service Plans
model ServicePlan {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        ServiceType
  status      ServiceStatus @default(ACTIVE)
  price       Decimal?
  currency    String   @default("AED")
  duration    Int?     // in months
  features    Json?    // Store plan features as JSON
  
  // Stage 2: ERP Connection & Data Sources
  erpConnection Json?  // { type: "ODOO|SAP|QUICKBOOKS|ZOHO|MANUAL", status: "CONNECTED|DISCONNECTED|ERROR", lastSync: DateTime, mappingHealth: number }
  dataDomains   String[] // ["AR", "AP", "GL", "SALES", "INVENTORY", "PAYROLL"]
  
  // Stage 5: Governance Policy
  governancePolicy Json? // { approvalMode: "MODE_A|MODE_B|MODE_C", notificationChannels: ["EMAIL","SMS","PUSH","IN_APP"], reportCadence: "WEEKLY|BIWEEKLY|MONTHLY|QUARTERLY", slaResponseHours: number, escalationEnabled: boolean }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tasks      Task[]
  
  // New relations for Plan Builder stages
  kpis        PlanKPI[]
  pricing     PlanPricing?
  assignments Assignment[]

  @@map("service_plans")
}

enum ServiceType {
  BASIC_CFO
  PREMIUM_CFO
  ENTERPRISE_CFO
  CONSULTING
  AUDIT
  TAX_FILING
  CUSTOM
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  COMPLETED
}

// Task Management
model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        TaskType
  priority    Priority @default(MEDIUM)
  status      TaskStatus @default(PENDING)
  
  // Budget & Financial
  budget      Decimal?   // Total task budget agreed with customer
  actualCost  Decimal?   // Actual cost incurred so far
  
  dueDate     DateTime?
  completedAt DateTime?
  estimatedHours Int?
  actualHours    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  servicePlanId String?
  servicePlan   ServicePlan? @relation(fields: [servicePlanId], references: [id])
  
  // Task can have one Plan with multiple Milestones
  plans         Plan[]   // A task can have multiple plans (versions/iterations)
  
  createdById   String
  createdBy     User @relation("TaskCreator", fields: [createdById], references: [id])
  updatedById   String?
  updatedBy     User? @relation("TaskUpdater", fields: [updatedById], references: [id])
  assignments   TaskAssignment[]

  @@map("tasks")
}

enum TaskType {
  FINANCIAL_REVIEW
  TAX_PREPARATION
  BUDGET_PLANNING
  AUDIT_SUPPORT
  COMPLIANCE_CHECK
  REPORTING
  CONSULTATION
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

// Task Assignments
model TaskAssignment {
  id        String   @id @default(cuid())
  assignedAt DateTime @default(now())
  status    AssignmentStatus @default(ASSIGNED)
  notes     String?

  // Relations
  taskId String
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@map("task_assignments")
}

enum AssignmentStatus {
  ASSIGNED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

// Communication Log
model Communication {
  id        String   @id @default(cuid())
  type      CommunicationType
  subject   String?
  content   String
  direction CommunicationDirection
  createdAt DateTime @default(now())

  // Relations
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("communications")
}

enum CommunicationType {
  EMAIL
  PHONE
  MEETING
  CHAT
  DOCUMENT
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

// System Settings
model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String
  type  SettingType @default(STRING)
  description String?

  @@map("settings")
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// Partner Management
model Partner {
  id        String      @id @default(cuid())
  name      String
  email     String?
  phone     String?
  country   String
  city      String?     // City for same-city matching
  address   String?     // Full address
  latitude  Float?      // For distance calculation
  longitude Float?      // For distance calculation
  domain    String      // Area of expertise e.g., Odoo, Stock Count
  role      PartnerRole // Functional role e.g., Technical, Accounts, ERP Consultant
  specialties Json?     // Array of service specialties e.g., ["Network Infrastructure", "Security Systems"]
  rating    Float?      @default(0) // 0-5 star rating
  activeEngagements Int @default(0) // Current workload
  availability      PartnerAvailability @default(AVAILABLE)
  remoteOk  Boolean     @default(false) // Can work remotely
  notes     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  // Relations
  assignments Assignment[]

  @@index([country])
  @@index([city])
  @@index([domain])
  @@index([role])
  @@index([latitude, longitude])
  @@map("partners")
}

enum PartnerRole {
  ERP_CONSULTANT
  TECHNICAL
  ACCOUNTS
  STOCK_COUNT
  IMPLEMENTATION
  TRAINING
  OTHER
}

enum PartnerAvailability {
  AVAILABLE       // Within 24 hours
  MODERATE        // Within 48 hours
  BUSY            // Within 72 hours
  UNAVAILABLE     // Not available
}

// Contracts & Templates

enum ContractType {
  SERVICE_AGREEMENT
  NDA
  MSA
  SOW
  PROPOSAL
  CUSTOM
}

enum ContractStatus {
  DRAFT
  GENERATED
  SENT
  VIEWED
  SIGNED
  FAILED
}

enum Brand {
  GREENLINES
  GLERP
  OTHER
}

enum AIProvider {
  OPENAI
  GEMINI
  ANTHROPIC
  CUSTOM
}

model CompanyProfile {
  id          String   @id @default(cuid())
  name        String              // Display name e.g., Green Lines, GLERP
  brand       Brand
  legalName   String
  email       String
  phone       String?
  address     String?
  city        String?
  country     String?
  logoUrl     String?
  signerName  String?
  signerTitle String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  contracts   Contract[]

  @@map("company_profiles")
}

model ContractTemplate {
  id            String       @id @default(cuid())
  name          String
  type          ContractType
  language      String       @default("en") // en or ar; UI will control RTL/LTR
  industry      String?
  brand         Brand?
  defaultContent String     // Template text with placeholders like {{companyName}}
  variables     Json?        // e.g., ["companyName","price","currency","termMonths"]
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  contracts     Contract[]

  @@map("contract_templates")
}

model Contract {
  id              String         @id @default(cuid())
  type            ContractType
  status          ContractStatus @default(DRAFT)
  language        String         @default("en")
  industry        String?
  variables       Json?          // Resolved variables for this instance
  generatedContent String?       // Raw generated text (optional)
  pdfPath         String?        // Stored PDF path/key
  aiProvider      AIProvider?    // Which AI was used to generate
  sentAt          DateTime?
  signedAt        DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  templateId      String?
  template        ContractTemplate? @relation(fields: [templateId], references: [id])

  senderCompanyId String
  senderCompany   CompanyProfile   @relation(fields: [senderCompanyId], references: [id])

  customerId      String?
  customer        Customer?        @relation(fields: [customerId], references: [id])

  recipientEmail  String
  recipientName   String?
  createdById     String
  createdBy       User             @relation(fields: [createdById], references: [id])

  @@index([type])
  @@index([status])
  @@index([senderCompanyId])
  @@index([customerId])
  @@map("contracts")
}

// Plan Builder - Service Plans
model Plan {
  id                String   @id @default(cuid())
  name              String
  description       String?
  
  // Relations
  customerId        String
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  taskId            String?  // Optional: Plan belongs to a Task
  task              Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // Basic Information (Stage 1)
  industry          String
  companySize       String
  durationType      String   @default("WEEKS")
  durationWeeks     Int?
  startDate         DateTime?
  workingDays       Int      @default(5)
  address           String?
  siteType          String?
  accessRequirements String?
  
  // Plan Status
  status            PlanStatus @default(DRAFT)
  currentStage      Int        @default(1)
  totalStages       Int        @default(7)
  totalBudget       Decimal    @default(0)  // Calculated from milestones
  currency          String     @default("SAR")
  notes             String?
  
  // Timestamps
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  // Relations
  milestones        Milestone[]
  resources         Resource[]
  services          Service[]
  attachments       Attachment[]

  @@map("plans")
}

enum PlanStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

// Plan Milestones (Stage 2)
model Milestone {
  id              String   @id @default(cuid())
  planId          String
  plan            Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  sequence        Int
  name            String
  description     String?
  durationWeeks   Int
  budgetAllocation Decimal // Percentage (0-100)
  deliverables    String?
  dependencies    String?  // JSON array of milestone IDs
  isCriticalPath  Boolean  @default(false)
  
  // Status tracking
  status          MilestoneStatus @default(PENDING)
  startDate       DateTime?
  completedDate   DateTime?
  actualCost      Decimal?  // Actual cost for this milestone
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("milestones")
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  DELAYED
  CANCELLED
}

// Plan Resources (Stage 3)
model Resource {
  id          String   @id @default(cuid())
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  name        String
  type        ResourceType
  quantity    Int        @default(1)
  cost        Decimal?
  currency    String     @default("SAR")
  description String?
  
  // Timestamps
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("resources")
}

enum ResourceType {
  HUMAN_RESOURCE
  EQUIPMENT
  SOFTWARE
  MATERIAL
  OTHER
}

// Plan Attachments (Stage 6)
model Attachment {
  id          String   @id @default(cuid())
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  name        String
  type        String
  size        Int
  url         String
  description String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("attachments")
}

// Stage 3: Plan KPIs
model PlanKPI {
  id                String   @id @default(cuid())
  servicePlanId     String
  servicePlan       ServicePlan @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  
  kpiName           String
  targetValue       Float
  thresholdGreen    Float    // e.g., >= 90%
  thresholdAmber    Float    // e.g., 70-89%
  thresholdRed      Float    // e.g., < 70%
  weight            Float    // percentage of total (must sum to 100)
  calculationSource String
  effectiveFrom     DateTime
  effectiveTo       DateTime?
  actualValue       Float?
  status            String?  // "GREEN" | "AMBER" | "RED"
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("plan_kpis")
}

// Stage 6: Plan Pricing
model PlanPricing {
  id                    String   @id @default(cuid())
  servicePlanId         String   @unique
  servicePlan           ServicePlan @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  
  package               String   // "BASIC" | "STANDARD" | "PREMIUM" | "CUSTOM"
  addOns                String[] // ["EXTRA_USERS", "ADVANCED_REPORTING", "API_ACCESS", "DEDICATED_SUPPORT"]
  basePrice             Float
  totalPrice            Float
  platformCommissionPct Float
  partnerCommissionPct  Float
  payoutDelayDays       Int
  refundPolicy          String
  contractStartDate     DateTime
  contractEndDate       DateTime
  paymentTerms          String   // "NET_15" | "NET_30" | "NET_60" | "NET_90"
  proposalGenerated     Boolean  @default(false)
  proposalPath          String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("plan_pricing")
}

// Stage 7: Assignments
model Assignment {
  id              String   @id @default(cuid())
  servicePlanId   String
  servicePlan     ServicePlan @relation(fields: [servicePlanId], references: [id], onDelete: Cascade)
  
  type            String   // "SETUP" | "TRAINING" | "IMPLEMENTATION" | "SUPPORT"
  partnerId       String?
  partner         Partner? @relation(fields: [partnerId], references: [id])
  assignmentOwner String
  slaHours        Int
  dueDate         DateTime
  priority        String   // "LOW" | "MEDIUM" | "HIGH" | "URGENT"
  status          String   @default("PENDING") // "PENDING" | "IN_PROGRESS" | "COMPLETED"
  notes           String?
  attachments     String[] // file paths
  notifyPartner   Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("assignments")
}

// Service - Additional service model
model Service {
  id          String   @id @default(cuid())
  planId      String
  plan        Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  quantity    Int      @default(1)
  price       Decimal?
  currency    String   @default("SAR")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("services")
}

// ========================================
// Global Controls - Notifications System
// ========================================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        NotificationType
  title       String
  message     String
  link        String?   // Deep link to relevant page
  
  // Reference to source entity (polymorphic)
  entityType  String?   // "TASK" | "PLAN" | "CUSTOMER" | "PARTNER" | "CONTRACT"
  entityId    String?   // ID of the related entity
  
  isRead      Boolean  @default(false)
  readAt      DateTime?
  
  priority    NotificationPriority @default(NORMAL)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_COMPLETED
  TASK_OVERDUE
  PLAN_CREATED
  PLAN_UPDATED
  PLAN_COMPLETED
  PARTNER_ASSIGNED
  CONTRACT_SIGNED
  APPROVAL_PENDING
  PAYMENT_RECEIVED
  SYSTEM_ALERT
  CUSTOM
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ========================================
// Global Controls - User Preferences
// ========================================

model UserPreference {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Display Preferences
  language    String   @default("en")      // "en" | "ar"
  currency    String   @default("AED")     // "AED" | "SAR" | "USD" | "EUR" | "GBP"
  timezone    String   @default("Asia/Dubai")
  dateFormat  String   @default("DD/MM/YYYY")
  
  // Default Filters (applied globally)
  defaultRegion     String?   // "GCC" | "MENA" | "APAC" | "EU"
  defaultOrg        String?   // Organization ID (for future multi-org support)
  defaultDateRange  String    @default("THIS_MONTH")
  
  // Notification Preferences
  emailNotifications    Boolean @default(true)
  pushNotifications     Boolean @default(true)
  smsNotifications      Boolean @default(false)
  
  // UI Preferences
  sidebarCollapsed      Boolean @default(false)
  dashboardLayout       Json?   // Custom dashboard layout
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("user_preferences")
}

// ========================================
// Global Controls - Search Logs
// ========================================

model SearchLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  query       String
  category    String?  // "ALL" | "CUSTOMERS" | "PLANS" | "TASKS" | "PARTNERS"
  resultsCount Int     @default(0)
  
  // Track what user clicked
  clickedEntityType String?
  clickedEntityId   String?
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@map("search_logs")
}

// ========================================
// Global Controls - Notification Preferences
// ========================================

model NotificationPreference {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  notificationType  NotificationType
  
  // Channels
  emailEnabled      Boolean  @default(true)
  pushEnabled       Boolean  @default(true)
  smsEnabled        Boolean  @default(false)
  inAppEnabled      Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([userId, notificationType])
  @@map("notification_preferences")
}

// ========================================
// ERP Integration
// ========================================

model ERPConnection {
  id              String   @id @default(cuid())
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // ERP Configuration
  erpType         String   // ODOO, SALESFORCE, SAP, ZOHO, QUICKBOOKS, ORACLE
  status          String   @default("NOT_CONNECTED") // NOT_CONNECTED, CONNECTING, CONNECTED, ERROR, DISCONNECTED
  
  // Encrypted credentials stored as JSON string
  // Contains: odooUrl, odooDatabase, odooUsername, odooPassword for Odoo
  // Or: salesforceInstanceUrl, salesforceClientId, salesforceClientSecret, etc for Salesforce
  credentialsEncrypted String @db.Text
  
  // Connection metadata
  lastSyncDate    DateTime?
  lastSyncStatus  String?   // SUCCESS, FAILED, PARTIAL
  lastSyncError   String?   @db.Text
  mappingHealth   Int       @default(0) // 0-100 percentage
  
  // Data domains synced from ERP
  dataDomains     String[]  // ['AR', 'AP', 'GL', 'Sales', 'Inventory', 'Payroll']
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  syncHistory     ERPSyncHistory[]
  
  @@index([customerId])
  @@index([erpType])
  @@index([status])
  @@map("erp_connections")
}

model ERPSyncHistory {
  id              String   @id @default(cuid())
  connectionId    String
  connection      ERPConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  
  // Sync details
  syncType        String   // FULL, INCREMENTAL, MANUAL, SCHEDULED
  status          String   // SUCCESS, FAILED, PARTIAL
  
  // Metrics
  recordsProcessed Int     @default(0)
  recordsSkipped   Int     @default(0)
  
  // Errors and warnings
  errors          String[] @default([])
  warnings        String[] @default([])
  
  // Timing
  startTime       DateTime
  endTime         DateTime
  duration        Int      // milliseconds
  
  // Metadata
  triggeredBy       String?   // USER_ID or "SYSTEM" for scheduled syncs
  dataDomainsSynced String[] @map("dataDomainssynced") // Which domains were synced in this run
  
  createdAt         DateTime  @default(now())
  
  @@index([connectionId, createdAt])
  @@index([status])
  @@map("erp_sync_history")
}
